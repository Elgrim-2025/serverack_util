<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„œë²„ ë™ ì—ë””í„° (ë¼ë²¨ í‘œì‹œ ê¸°ëŠ¥ ì¶”ê°€)</title>
    <style>
        /* --- ê¸°ë³¸ ìŠ¤íƒ€ì¼ --- */
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; background: #1e1e1e; color: #eee; display: flex; height: 100vh; overflow: hidden; }

        .main-content { flex: 1; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #1e1e1e; overflow: auto; padding: 20px; }
        .sidebar { width: 350px; background: #252526; border-left: 1px solid #333; display: flex; flex-direction: column; padding: 20px; overflow-y: auto; box-shadow: -5px 0 15px rgba(0,0,0,0.2); z-index: 20; }

        /* íˆ´ë°” */
        .toolbar { width: 100%; max-width: 900px; margin-bottom: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        button { cursor: pointer; padding: 8px 12px; border: none; border-radius: 4px; font-weight: bold; transition: 0.2s; white-space: nowrap; font-size: 0.9em; }

        .btn-primary { background: #007acc; color: white; }
        .btn-primary:hover { background: #005f9e; }
        .btn-danger { background: #d9534f; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-export { background: #6f42c1; color: white; }
        .btn-export:hover { background: #5a32a3; }
        .btn-import { background: #e0a800; color: black; }
        .btn-import:hover { background: #c69500; }

        .btn-toggle.active { background: #ffc107; color: black; box-shadow: 0 0 8px rgba(255, 193, 7, 0.5); }

        /* ì›Œí¬ìŠ¤í˜ì´ìŠ¤ */
        .workspace { position: relative; border: 2px solid #444; box-shadow: 0 0 20px rgba(0,0,0,0.5); user-select: none; }
        .workspace img { display: block; max-width: 100%; max-height: 85vh; pointer-events: none; }

        /* Zone ìŠ¤íƒ€ì¼ */
        .zone { position: absolute; border: 2px solid rgba(0, 255, 255, 0.5); background: rgba(0, 255, 255, 0.1); cursor: pointer; }
        .zone:hover { background: rgba(0, 255, 255, 0.3); z-index: 5; } /* í˜¸ë²„ ì‹œ ìœ„ë¡œ ì˜¬ë¼ì˜¤ê²Œ */
        .zone.selected { border-color: #ffc107; background: rgba(255, 193, 7, 0.2); z-index: 10; box-shadow: 0 0 10px rgba(255, 193, 7, 0.5); }

        /* â˜… ì¶”ê°€ëœ ë¼ë²¨ ìŠ¤íƒ€ì¼ â˜… */
        .zone-label {
            position: absolute;
            top: 0;
            left: 0;
            background: rgba(0, 0, 0, 0.7); /* ë°˜íˆ¬ëª… ê²€ì • ë°°ê²½ */
            color: #fff;
            padding: 2px 6px;
            font-size: 11px;
            font-weight: normal;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            pointer-events: none; /* ë¼ë²¨ì„ í´ë¦­í•´ë„ ë¶€ëª¨ì¸ zoneì´ í´ë¦­ë˜ë„ë¡ */
        }
        /* ì„ íƒëœ ì˜ì—­ì˜ ë¼ë²¨ì€ ë…¸ë€ìƒ‰ìœ¼ë¡œ ê°•ì¡° */
        .zone.selected .zone-label {
            background: #ffc107;
            color: #000;
            font-weight: bold;
        }

        /* í¼ ìŠ¤íƒ€ì¼ */
        h3 { margin-top: 0; color: #ddd; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.85em; color: #aaa; margin-bottom: 6px; }
        input, textarea { width: 100%; padding: 10px; background: #3c3c3c; border: 1px solid #555; color: white; border-radius: 4px; }
        input:focus, textarea:focus { outline: none; border-color: #007acc; background: #444; }

        .attr-row { display: flex; gap: 5px; margin-bottom: 8px; align-items: center; }
        .attr-key { flex: 1; font-size: 0.9em; }
        .attr-val { flex: 1.5; font-size: 0.9em; }
        .btn-remove { background: transparent; border: 1px solid #555; color: #aaa; padding: 6px 10px; }
        .btn-remove:hover { color: #ff6b6b; border-color: #ff6b6b; }

        .hidden { display: none !important; }
        .cursor-crosshair { cursor: crosshair !important; }
        .file-upload-wrapper { position: relative; overflow: hidden; display: inline-block; }
        .file-upload-wrapper input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; }
    </style>
</head>
<body>

<div class="main-content">
    <div class="toolbar">
        <div class="file-upload-wrapper">
            <button class="btn-primary">ğŸ“· ìƒˆ ì‚¬ì§„ ì‹œì‘</button>
            <input type="file" id="imgUpload" accept="image/*">
        </div>

        <div class="file-upload-wrapper">
            <button class="btn-import">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸° (ìˆ˜ì •)</button>
            <input type="file" id="projectUpload" accept=".html">
        </div>

        <div style="width: 1px; height: 20px; background: #555; margin: 0 10px;"></div>

        <button id="btnAddMode" class="btn-toggle" onclick="toggleAddMode()">+ ì˜ì—­ ì¶”ê°€</button>

        <div style="flex:1"></div>

        <button onclick="exportSingleHtml()" class="btn-export">ğŸ’¾ ì €ì¥/ë‚´ë³´ë‚´ê¸° (HTML)</button>
    </div>

    <span id="modeStatus" style="font-size: 0.9em; color: #ffc107; margin-bottom:5px; height: 20px;"></span>

    <div id="workspace" class="workspace">
        <img id="targetImage" src="" alt="ìƒˆ ì‚¬ì§„ì„ ì‹œì‘í•˜ê±°ë‚˜ ê¸°ì¡´ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ì„¸ìš”" style="display: none;">
    </div>
</div>

<div class="sidebar">
    <h3>Inspection (í¸ì§‘)</h3>

    <div id="emptyState" style="color: #777; text-align: center; margin-top: 50px; line-height: 1.6;">
        ì„œë²„ ì˜ì—­ì„ ì„ íƒí•˜ê±°ë‚˜<br>ìƒˆë¡œ ì¶”ê°€í•´ì£¼ì„¸ìš”.
    </div>

    <div id="editForm" class="hidden">
        <div class="form-group">
            <label>ì„œë²„ ì´ë¦„</label>
            <input type="text" id="inputName" placeholder="ì˜ˆ: Web Server 01" oninput="liveUpdateName()">
        </div>
        <div class="form-group">
            <label>ì„¤ëª… / ë©”ëª¨</label>
            <textarea id="inputDesc" rows="4" placeholder="ì„œë²„ ìš©ë„ë‚˜ íŠ¹ì´ì‚¬í•­..."></textarea>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; margin-top: 25px; border-bottom: 1px solid #444; padding-bottom: 8px;">
            <span style="font-weight: bold; font-size: 0.95em;">ì„¸ë¶€ ì†ì„±</span>
            <button onclick="addAttrField()" class="btn-success" style="font-size: 0.8em; padding: 4px 8px;">+ ì¶”ê°€</button>
        </div>

        <div id="attributesContainer"></div>

        <div style="margin-top: 40px; display: flex; gap: 10px; flex-direction: column;">
            <button onclick="saveChanges()" class="btn-primary" style="padding: 12px;">ì €ì¥ ë° ì ìš©</button>
            <button onclick="deleteZone()" class="btn-danger">ì˜ì—­ ì‚­ì œ</button>
        </div>
    </div>
</div>

<script>
    // --- ìƒíƒœ ë³€ìˆ˜ ---
    let zones = [];
    let isAddingMode = false;
    let isDrawing = false;
    let startX, startY;
    let selectedZoneId = null;
    let nextId = 1;

    // --- DOM Elements ---
    const workspace = document.getElementById('workspace');
    const targetImage = document.getElementById('targetImage');
    const imgUpload = document.getElementById('imgUpload');
    const projectUpload = document.getElementById('projectUpload');
    const btnAddMode = document.getElementById('btnAddMode');
    const editForm = document.getElementById('editForm');
    const emptyState = document.getElementById('emptyState');
    const attributesContainer = document.getElementById('attributesContainer');
    const modeStatus = document.getElementById('modeStatus');

    // ============================================
    // 1. ì´ˆê¸°í™” ë° íŒŒì¼ ë¡œë“œ
    // ============================================
    imgUpload.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(evt) {
                resetEditor();
                targetImage.src = evt.target.result;
                targetImage.style.display = 'block';
            }
            reader.readAsDataURL(file);
        }
        e.target.value = '';
    });

    projectUpload.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(evt) {
            const htmlContent = evt.target.result;
            const imgMatch = htmlContent.match(/<img src="(data:image\/[^"]+)"/);
            const zoneMatch = htmlContent.match(/const zones = (\[[\s\S]*?\]);/);

            if (imgMatch && zoneMatch) {
                resetEditor();
                targetImage.src = imgMatch[1];
                targetImage.style.display = 'block';
                try {
                    zones = JSON.parse(zoneMatch[1]);
                    if(zones.length > 0) {
                        const maxId = Math.max(...zones.map(z => z.id));
                        nextId = maxId + 1;
                    }
                    renderZones();
                    alert("í”„ë¡œì íŠ¸ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!");
                } catch(err) {
                    alert("ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜");
                }
            } else {
                alert("ì˜¬ë°”ë¥¸ HTML íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.");
            }
        };
        reader.readAsText(file);
        e.target.value = '';
    });

    function resetEditor() {
        zones = [];
        selectedZoneId = null;
        renderZones();
        deselect();
        nextId = 1;
    }

    // ============================================
    // 2. ì—ë””í„° ë™ì‘ ë¡œì§
    // ============================================
    function toggleAddMode() {
        if (!targetImage.src || targetImage.style.display === 'none') {
            alert("ì‚¬ì§„ì„ ë¨¼ì € ë¶ˆëŸ¬ì˜¤ì„¸ìš”.");
            return;
        }
        isAddingMode = !isAddingMode;
        if (isAddingMode) {
            btnAddMode.classList.add('active');
            workspace.classList.add('cursor-crosshair');
            modeStatus.innerText = "âœ¨ ë“œë˜ê·¸í•˜ì—¬ ì˜ì—­ì„ ê·¸ë¦¬ì„¸ìš”";
            deselect();
        } else {
            btnAddMode.classList.remove('active');
            workspace.classList.remove('cursor-crosshair');
            modeStatus.innerText = "";
        }
    }

    workspace.addEventListener('mousedown', (e) => {
        if (!isAddingMode || !targetImage.src) return;
        isDrawing = true;
        const rect = workspace.getBoundingClientRect();
        startX = e.clientX - rect.left;
        startY = e.clientY - rect.top;

        const ghost = document.createElement('div');
        ghost.id = 'ghost-box';
        ghost.style.position = 'absolute';
        ghost.style.border = '2px dashed #ffc107';
        ghost.style.left = startX + 'px';
        ghost.style.top = startY + 'px';
        workspace.appendChild(ghost);
    });

    workspace.addEventListener('mousemove', (e) => {
        if (!isDrawing) return;
        const rect = workspace.getBoundingClientRect();
        const currentX = e.clientX - rect.left;
        const currentY = e.clientY - rect.top;
        const width = Math.abs(currentX - startX);
        const height = Math.abs(currentY - startY);
        const left = Math.min(currentX, startX);
        const top = Math.min(currentY, startY);
        const ghost = document.getElementById('ghost-box');
        ghost.style.width = width + 'px';
        ghost.style.height = height + 'px';
        ghost.style.left = left + 'px';
        ghost.style.top = top + 'px';
    });

    workspace.addEventListener('mouseup', (e) => {
        if (!isDrawing) return;
        isDrawing = false;
        const ghost = document.getElementById('ghost-box');
        if(ghost) ghost.remove();

        const rect = workspace.getBoundingClientRect();
        const endX = e.clientX - rect.left;
        const endY = e.clientY - rect.top;
        const imgW = workspace.clientWidth;
        const imgH = workspace.clientHeight;
        const pixelW = Math.abs(endX - startX);
        const pixelH = Math.abs(endY - startY);

        if (pixelW < 20 || pixelH < 20) return;

        const finalLeft = (Math.min(startX, endX) / imgW) * 100;
        const finalTop = (Math.min(startY, endY) / imgH) * 100;
        const finalW = (pixelW / imgW) * 100;
        const finalH = (pixelH / imgH) * 100;

        const newZone = {
            id: nextId++,
            x: finalLeft, y: finalTop, w: finalW, h: finalH,
            name: 'Server ' + nextId,
            desc: '',
            attrs: []
        };
        zones.push(newZone);
        renderZones();
        selectZone(newZone.id);
        toggleAddMode();
    });

    // â˜… ë Œë”ë§ í•¨ìˆ˜ ìˆ˜ì •: ë¼ë²¨ ì¶”ê°€ â˜…
    function renderZones() {
        const oldZones = document.querySelectorAll('.zone');
        oldZones.forEach(el => el.remove());

        zones.forEach(z => {
            const div = document.createElement('div');
            div.className = 'zone';
            if(selectedZoneId === z.id) div.classList.add('selected');
            div.style.left = z.x + '%';
            div.style.top = z.y + '%';
            div.style.width = z.w + '%';
            div.style.height = z.h + '%';
            div.id = 'zone-' + z.id; // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ ID ë¶€ì—¬

            // ë¼ë²¨ ìƒì„±
            const label = document.createElement('div');
            label.className = 'zone-label';
            label.innerText = z.name;
            div.appendChild(label);

            div.onclick = (e) => {
                e.stopPropagation();
                if(!isAddingMode) selectZone(z.id);
            };
            workspace.appendChild(div);
        });
    }

    function selectZone(id) {
        selectedZoneId = id;
        renderZones();
        emptyState.classList.add('hidden');
        editForm.classList.remove('hidden');

        const zone = zones.find(z => z.id === id);
        document.getElementById('inputName').value = zone.name || '';
        document.getElementById('inputDesc').value = zone.desc || '';

        attributesContainer.innerHTML = '';
        if (zone.attrs) {
            zone.attrs.forEach(attr => addAttrField(attr.key, attr.val));
        }
    }

    function deselect() {
        selectedZoneId = null;
        renderZones();
        emptyState.classList.remove('hidden');
        editForm.classList.add('hidden');
    }

    // â˜… ì‹¤ì‹œê°„ ì´ë¦„ ì—…ë°ì´íŠ¸ ê¸°ëŠ¥ â˜…
    function liveUpdateName() {
        if (!selectedZoneId) return;
        const newName = document.getElementById('inputName').value;

        // ë°ì´í„° ì—…ë°ì´íŠ¸
        const zone = zones.find(z => z.id === selectedZoneId);
        if (zone) zone.name = newName;

        // DOM ì¦‰ì‹œ ì—…ë°ì´íŠ¸ (ì „ì²´ ë¦¬ë Œë”ë§ ì—†ì´ ë¼ë²¨ë§Œ ë³€ê²½)
        const zoneEl = document.getElementById('zone-' + selectedZoneId);
        if (zoneEl) {
            const label = zoneEl.querySelector('.zone-label');
            if (label) label.innerText = newName;
        }
    }

    function addAttrField(key = '', val = '') {
        const row = document.createElement('div');
        row.className = 'attr-row';
        row.innerHTML = `
                <input type="text" class="attr-key" placeholder="ì†ì„±ëª…" value="${key}">
                <input type="text" class="attr-val" placeholder="ê°’" value="${val}">
                <button class="btn-remove" onclick="this.parentElement.remove()">X</button>
            `;
        attributesContainer.appendChild(row);
    }

    function saveChanges() {
        if (!selectedZoneId) return;
        // liveUpdateNameì—ì„œ ì´ë¯¸ nameì€ ì—…ë°ì´íŠ¸ ë¨
        const zone = zones.find(z => z.id === selectedZoneId);
        zone.name = document.getElementById('inputName').value; // í˜¹ì‹œ ëª°ë¼ í•œë²ˆ ë”
        zone.desc = document.getElementById('inputDesc').value;

        const rows = document.querySelectorAll('.attr-row');
        const newAttrs = [];
        rows.forEach(row => {
            const k = row.querySelector('.attr-key').value;
            const v = row.querySelector('.attr-val').value;
            if (k) newAttrs.push({ key: k, val: v });
        });
        zone.attrs = newAttrs;

        renderZones(); // ìµœì¢… ë°˜ì˜

        const btn = document.querySelector('#editForm .btn-primary');
        const originalText = btn.innerText;
        btn.innerText = "âœ” ë°˜ì˜ë¨";
        setTimeout(() => btn.innerText = originalText, 1000);
    }

    function deleteZone() {
        if (!selectedZoneId) return;
        if(confirm('ì´ ì˜ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            zones = zones.filter(z => z.id !== selectedZoneId);
            deselect();
        }
    }

    // ============================================
    // 3. ë‚´ë³´ë‚´ê¸° (ì €ì¥) ë¡œì§
    // ============================================
    function exportSingleHtml() {
        if (!targetImage.src || targetImage.style.display === 'none') {
            alert("ì €ì¥í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        const imageData = targetImage.src;
        const zonesData = JSON.stringify(zones);

        // ë·°ì–´ HTML í…œí”Œë¦¿ (ë¼ë²¨ ìŠ¤íƒ€ì¼ í¬í•¨)
        const htmlContent = `
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„œë²„ ì •ë³´ ë·°ì–´</title>
    <style>
        body { margin:0; padding:0; background:#1e1e1e; color:#eee; font-family:'Segoe UI', sans-serif; display:flex; height:100vh; overflow:hidden; }
        .viewer-container { flex:1; display:flex; justify-content:center; align-items:center; overflow:auto; padding:20px; position:relative; }
        .image-wrapper { position:relative; border:2px solid #444; box-shadow:0 0 20px rgba(0,0,0,0.5); }
        .image-wrapper img { display:block; max-width:100%; max-height:90vh; }

        .zone { position:absolute; cursor:pointer; border:1px solid rgba(255,255,255,0.3); background:rgba(0,255,255,0.1); transition:0.2s; }
        .zone:hover, .zone.active { background:rgba(0,255,255,0.3); border-color:#00e5ff; box-shadow:0 0 10px #00e5ff; z-index: 10; }

        /* ë·°ì–´ìš© ë¼ë²¨ ìŠ¤íƒ€ì¼ */
        .zone-label {
            position: absolute; top: 0; left: 0;
            background: rgba(0, 0, 0, 0.7); color: #fff;
            padding: 2px 6px; font-size: 11px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%;
        }
        .zone.active .zone-label { background: #00e5ff; color: #000; font-weight: bold; }

        .info-panel { width:320px; background:#252526; border-left:1px solid #333; padding:25px; overflow-y:auto; box-shadow:-5px 0 15px rgba(0,0,0,0.3); display:flex; flex-direction:column; }
        .info-title { font-size:1.5em; color:#fff; border-bottom:1px solid #444; padding-bottom:10px; margin-top:0; }
        .info-desc { color:#ccc; line-height:1.5; margin-bottom:20px; white-space: pre-wrap; }
        .attr-table { width:100%; border-collapse:collapse; margin-top:10px; }
        .attr-table th, .attr-table td { text-align:left; padding:8px; border-bottom:1px solid #444; font-size:0.9em; }
        .attr-table th { color:#888; width:40%; }
        .attr-table td { color:#fff; font-weight:bold; }
        .empty-msg { color:#666; text-align:center; margin-top:50%; }
    </style>
</head>
<body>
    <div class="viewer-container">
        <div class="image-wrapper" id="imgWrapper">
            <img src="${imageData}">
        </div>
    </div>
    <div class="info-panel" id="infoPanel">
        <div class="empty-msg">ì„œë²„ ì˜ì—­ì„ í´ë¦­í•˜ì—¬<br>ìƒì„¸ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.</div>
    </div>

    <script>
        const zones = ${zonesData};

        const imgWrapper = document.getElementById('imgWrapper');
        const infoPanel = document.getElementById('infoPanel');

        zones.forEach(z => {
            const div = document.createElement('div');
            div.className = 'zone';
            div.style.left = z.x + '%';
            div.style.top = z.y + '%';
            div.style.width = z.w + '%';
            div.style.height = z.h + '%';

            // ë¼ë²¨ ì¶”ê°€
            const label = document.createElement('div');
            label.className = 'zone-label';
            label.innerText = z.name;
            div.appendChild(label);

            div.onclick = (e) => showInfo(z, div);
            imgWrapper.appendChild(div);
        });

        function showInfo(z, element) {
            document.querySelectorAll('.zone').forEach(el => el.classList.remove('active'));
            element.classList.add('active');

            let attrHtml = '';
            if(z.attrs && z.attrs.length > 0) {
                attrHtml = '<table class="attr-table">';
                z.attrs.forEach(attr => {
                    attrHtml += \`<tr><th>\${attr.key}</th><td>\${attr.val}</td></tr>\`;
                });
                attrHtml += '</table>';
            }

            infoPanel.innerHTML = \`
                <h2 class="info-title">\${z.name}</h2>
                <div class="info-desc">\${z.desc || 'ì„¤ëª… ì—†ìŒ'}</div>
                \${attrHtml}
            \`;
        }
    <\/script>
</body>
</html>`;

        const blob = new Blob([htmlContent], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'server_rack_project_v2.html';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
</script>
</body>
</html>